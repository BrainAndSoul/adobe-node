{"version":3,"file":"listener.js","sourceRoot":"","sources":["../src/listener.ts"],"names":[],"mappings":";;AACA,2BAAmD;AAEnD,IAAM,mBAAmB,GAAG,UAAC,IAAY,EAAE,IAAY,EAAE,QAAuC;IAE9F,IAAM,SAAS,GAA0B,IAAI,GAAG,EAAoB,CAAC;IACrE,IAAI,MAAc,CAAC;IACnB,IAAI,MAAa,CAAC;IAElB,SAAS,kBAAkB,CAAC,MAAc;QACxC,MAAM,GAAG,MAAM,CAAC;QAChB,MAAM,CAAC,EAAE,CAAC,MAAM,EAAE,UAAC,MAAc;YAC/B,IAAM,IAAI,GAAqB,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,QAAQ,EAAE,CAAC,CAAC;YAE7D,IAAI,SAAS,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE;gBAC/B,SAAS,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;aACvD;YAED,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QACzB,CAAC,CAAC,CAAC;IACL,CAAC;IAED,SAAS,aAAa;QACpB,IAAG,MAAM,EAAE;YACT,MAAM,CAAC,GAAG,EAAE,CAAC;SACd;QACD,MAAM,GAAG,IAAI,CAAC;QACd,OAAO,CAAC,GAAG,CAAC,wDAAiD,IAAI,CAAE,CAAC,CAAC;IACvE,CAAC;IAED,OAAO;QACL,gBAAgB,EAAE,UAAC,KAAa,EAAE,QAAkB;YAClD,IAAI,SAAS,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE;gBACxB,OAAO,CAAC,IAAI,CAAC,UAAG,KAAK,kCAA+B,CAAC,CAAC;aACvD;YACD,SAAS,CAAC,GAAG,CAAC,KAAK,EAAE,QAAQ,CAAC,CAAC;QACjC,CAAC;QACD,KAAK,EAAE;YACL,IAAI,MAAM;gBAAE,OAAO;YACnB,MAAM,GAAG,IAAA,kBAAY,EAAC,kBAAkB,CAAC,CAAC;YAC1C,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,IAAI,EAAE;gBACxB,OAAO,CAAC,GAAG,CAAC,0CAAmC,IAAI,cAAI,IAAI,CAAE,CAAC,CAAC;YACjE,CAAC,CAAC,CAAC;QACL,CAAC;QACD,KAAK,EAAE;YACL,MAAM,CAAC,KAAK,CAAC,aAAa,CAAC,CAAC;QAC9B,CAAC;KACF,CAAA;AACH,CAAC,CAAA;AAED,kBAAe,mBAAmB,CAAC","sourcesContent":["import { AdobeEventListener, BroadcastMessage } from './api';\r\nimport { Socket, Server, createServer } from 'net';\r\n\r\nconst newAdobeAppListener = (host: string, port: number, callback: (commandName: string) => void): AdobeEventListener => {\r\n  \r\n  const callbacks: Map<string, Function> = new Map<string, Function>();\r\n  let server: Server;\r\n  let client:Socket;\r\n\r\n  function connectionListener(socket: Socket) {\r\n    client = socket;\r\n    socket.on('data', (buffer: Buffer) => {\r\n      const data: BroadcastMessage = JSON.parse(buffer.toString());\r\n      \r\n      if (callbacks.has(data.command)) {\r\n        callbacks.get(data.command)(data.stdout, data.stderr);\r\n      }\r\n\r\n      callback(data.command);\r\n    });\r\n  }\r\n\r\n  function disposeServer() {\r\n    if(client) {\r\n      client.end();\r\n    }\r\n    server = null;\r\n    console.log(`Adobe Event Listener has been stopped at port ${port}`);\r\n  }\r\n\r\n  return {\r\n    addEventListener: (event: string, callback: Function): void => {\r\n      if (callbacks.has(event)) {\r\n        console.warn(`${event} listener will be overwritten`);\r\n      }\r\n      callbacks.set(event, callback);\r\n    },\r\n    start: (): void => {\r\n      if (server) return;\r\n      server = createServer(connectionListener);\r\n      server.listen(port, host, () => {\r\n        console.log(`Adobe Event Listener running at ${host}:${port}`);\r\n      });\r\n    },\r\n    close: (): void => {\r\n      server.close(disposeServer);\r\n    }\r\n  }\r\n}\r\n\r\nexport default newAdobeAppListener;\r\n"]}